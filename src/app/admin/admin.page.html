<ion-header [translucent]="true">
  <ion-toolbar color="tertiary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    
    <ion-title>
      Panel de Administrador
      <ion-icon name="hammer-outline"></ion-icon>
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button (click)="logout()" fill="clear" color="danger">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="tertiary">
    <ion-segment [(ngModel)]="currentView" value="users" mode="md">
      <ion-segment-button value="users">
        <ion-label>Usuarios ({{ users.length }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="tasks">
        <ion-label>Tareas Globales ({{ allTasks.length }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="trashedTasks">
        <ion-label>Papelera ({{ trashedTasks.length }})</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <div *ngIf="currentView === 'users'">
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Gestión de Usuarios</ion-label>
        <ion-button (click)="loadUsers()" fill="clear">
          <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
        </ion-button>
      </ion-list-header>

      <ion-item *ngIf="isLoadingUsers">
        <ion-spinner slot="start"></ion-spinner>
        <ion-label>Cargando usuarios...</ion-label>
      </ion-item>

      @for (user of users; track user._id) {
        <ion-item>
          <ion-icon slot="start" 
            [name]="user.role === 'ADMIN' ? 'shield-outline' : 'person-outline'" 
            [color]="user.role === 'ADMIN' ? 'warning' : 'medium'">
          </ion-icon>

          <ion-label>
            <h2>{{ user.username }}</h2>
            <p>ID: {{ user._id }} | Rol: <strong>{{ user.role }}</strong></p>
          </ion-label>
          
          <ion-button 
            slot="end" 
            fill="clear" 
            color="danger" 
            (click)="deleteUser(user)" 
            [disabled]="user.role === 'ADMIN' || user._id === authService.currentUserId"
          >
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
      }
    </ion-list>
  </div>
  
  <div *ngIf="currentView === 'tasks'">
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Tareas Globales</ion-label>
        
        <ion-button (click)="loadAllTasks()" fill="clear">
          <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
        </ion-button>
        
        <ion-button (click)="openCreateTaskModal()" fill="solid" color="success">
          <ion-icon slot="start" name="add-circle-outline"></ion-icon>
          Crear Tarea
        </ion-button>
      </ion-list-header>

      <ion-item *ngIf="isLoadingTasks">
        <ion-spinner slot="start"></ion-spinner>
        <ion-label>Cargando tareas globales...</ion-label>
      </ion-item>

      @for (task of allTasks; track task._id) {
        <ion-item class="admin-task-item" [class.completed]="task.completed">
          <ion-icon slot="start" 
            [name]="task.completed ? 'checkmark-circle-outline' : 'time-outline'" 
            [color]="task.completed ? 'success' : 'primary'">
          </ion-icon>

          <ion-label class="ion-text-wrap">
            <h2>{{ task.title }}</h2>

            <div class="task-tags">
              <ion-chip *ngFor="let tag of task.tags" size="small" color="secondary">
                <ion-label>{{ tag }}</ion-label>
              </ion-chip>
            </div>
            
            <p class="task-owner">
              Asignada a: 
              <span class="username-text">
                {{ getUserList(task) }}
              </span>
            </p>
            
            <p class="task-description">{{ task.description || 'Sin descripción' }}</p>
          </ion-label>

          <ion-button slot="end" fill="clear" color="danger" (click)="deleteAdminTask(task)">
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
      }
    </ion-list>
  </div>

  <div *ngIf="currentView === 'trashedTasks'">
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Tareas en Papelera</ion-label>
        
        <ion-button (click)="loadTrashedTasks()" fill="clear">
          <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
        </ion-button>
      </ion-list-header>

      <ion-item *ngIf="isLoadingTrashedTasks">
        <ion-spinner slot="start"></ion-spinner>
        <ion-label>Cargando tareas de la papelera...</ion-label>
      </ion-item>
      
      @for (task of trashedTasks; track task._id) {
        <ion-item class="admin-task-item" detail="false">
          <ion-icon slot="start" name="trash-bin-outline" color="danger"></ion-icon>

          <ion-label class="ion-text-wrap">
            <h2>{{ task.title }} (Papelera)</h2>

            <div class="task-tags">
              <ion-chip *ngFor="let tag of task.tags" size="small" color="secondary">
                <ion-label>{{ tag }}</ion-label>
              </ion-chip>
            </div>
            
            <p class="task-owner">
              Asignada a: 
              <span class="username-text">
                {{ getUserList(task) }}
              </span>
            </p>
            
            <p class="task-description">{{ task.description || 'Sin descripción' }}</p>
          </ion-label>

          <div slot="end" class="ion-text-end">
             <ion-button 
              size="small" 
              fill="outline" 
              color="primary" 
              (click)="restoreTask(task)"
            >
              <ion-icon slot="icon-only" name="refresh-circle-outline"></ion-icon>
            </ion-button>
            
            <ion-button 
              size="small" 
              fill="solid" 
              color="danger" 
              (click)="deleteTaskPermanent(task)"
            >
              <ion-icon slot="icon-only" name="skull-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      }
    </ion-list>
  </div>

</ion-content>