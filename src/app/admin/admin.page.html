<ion-header [translucent]="true">
  <ion-toolbar color="warning">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    
    <ion-title>
      Panel de Administrador
      <ion-icon name="hammer-outline"></ion-icon>
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button (click)="logout()" fill="clear" color="dark">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="warning">
    <ion-segment [(ngModel)]="currentView" value="users" mode="md">
      <ion-segment-button value="users">
        <ion-label>Usuarios ({{ users.length }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="tasks">
        <ion-label>Tareas Globales ({{ allTasks.length }})</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <div *ngIf="currentView === 'users'">
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Cuentas Registradas</ion-label>
        <ion-button (click)="loadUsers()" fill="clear" color="primary" [disabled]="isLoading">
          <ion-icon slot="icon-only" [name]="isLoading ? 'sync-outline' : 'refresh-outline'" [class.spin]="isLoading"></ion-icon>
        </ion-button>
      </ion-list-header>

      <ion-item *ngIf="isLoading">
        <ion-spinner name="crescent" slot="start"></ion-spinner>
        <ion-label>Cargando usuarios...</ion-label>
      </ion-item>
      
      @for (user of users; track user._id) {
        <ion-item>
          <ion-icon slot="start" 
            [name]="user.isAdmin ? 'shield-checkmark-outline' : 'person-outline'" 
            [color]="user.isAdmin ? 'danger' : 'medium'">
          </ion-icon>

          <ion-label class="ion-text-wrap">
            <h2>{{ user.username }}</h2>
            <p>ID: {{ user._id }}</p>
            <p>Registrado: {{ user.createdAt | date: 'shortDate' }}</p>
          </ion-label>
          
          <ion-chip slot="end" [color]="user.isAdmin ? 'danger' : 'success'">
              {{ user.isAdmin ? 'ADMIN' : 'USER' }}
          </ion-chip>
          
          @if (!user.isAdmin) {
              <ion-button slot="end" fill="clear" color="danger" (click)="deleteUser(user._id!)">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-button>
          } @else {
               <ion-button slot="end" fill="clear" color="medium" [disabled]="true">
                  <ion-icon slot="icon-only" name="lock-closed-outline"></ion-icon>
              </ion-button>
          }
        </ion-item>
      }
    </ion-list>
  </div>

  <div *ngIf="currentView === 'tasks'">
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Tareas del Sistema</ion-label>
        <ion-button (click)="loadAllTasks()" fill="clear" color="primary" [disabled]="isTasksLoading">
          <ion-icon slot="icon-only" [name]="isTasksLoading ? 'sync-outline' : 'refresh-outline'" [class.spin]="isTasksLoading"></ion-icon>
        </ion-button>
      </ion-list-header>

      <ion-item *ngIf="isTasksLoading">
        <ion-spinner name="crescent" slot="start"></ion-spinner>
        <ion-label>Cargando tareas globales...</ion-label>
      </ion-item>

      @for (task of allTasks; track task._id) {
        <ion-item class="admin-task-item" [class.completed]="task.completed">
          <ion-icon slot="start" 
            [name]="task.completed ? 'checkmark-circle-outline' : 'time-outline'" 
            [color]="task.completed ? 'success' : 'primary'">
          </ion-icon>

          <ion-label class="ion-text-wrap">
            <h2>{{ task.title }}</h2>
            <p class="task-owner">
              Dueño: 
              <span class="username-text">
                {{ task.user?.username || 'Usuario Eliminado' }}
              </span>
            </p>
            <p class="task-description">{{ task.description || 'Sin descripción' }}</p>
          </ion-label>

          <ion-button slot="end" fill="clear" color="danger" (click)="deleteAdminTask(task)">
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
      }
      
      @if (allTasks.length === 0 && !isTasksLoading) {
        <ion-item>
          <ion-label class="ion-text-center">No hay tareas registradas en el sistema.</ion-label>
        </ion-item>
      }
    </ion-list>
  </div>

</ion-content>